
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A friendly wrapper for modern SQLAlchemy and Alembic">
      
      
      
      
        <link rel="canonical" href="https://jpsca.github.io/sqla-wrapper/testing-with-a-real-database/">
      
      <link rel="icon" href="../assets/img/favicon.svg">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.4">
    
    
      
        <title>Testing with a real database - SQLA Wrapper</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.db9e7362.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Convergence:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Convergence";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../assets/css/highlight.css">
    
      <link rel="stylesheet" href="../assets/css/common.css">
    
    
      


    
    



<meta property="og:type" content="website" />
<meta property="og:title" content="SQLA Wrapper - Testing with a real database" />
<meta property="og:description" content="A friendly wrapper for modern SQLAlchemy and Alembic" />
<meta property="og:url" content="https://jpsca.github.io/sqla-wrapper/testing-with-a-real-database/" />
<meta property="og:image" content="https://jpsca.github.io/sqla-wrapper/assets/img/social.png" />
<meta property="og:image:type" content="image/png" />
<meta property="og:image:width" content="1280" />
<meta property="og:image:height" content="630" />
<meta name="twitter:card" content="summary_large_image">

<script defer data-domain="jpsca.github.io" src="https://plausible.io/js/plausible.js"></script>

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="pink">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
      <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#testing-with-a-real-database" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="SQLA Wrapper" class="md-header__button md-logo" aria-label="SQLA Wrapper" data-md-component="logo">
      
  <img src="../assets/img/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SQLA Wrapper
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Testing with a real database
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="pink"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 10.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5zM8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0V.75A.75.75 0 0 1 8 0zm0 13a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 8 13zM2.343 2.343a.75.75 0 0 1 1.061 0l1.06 1.061a.75.75 0 0 1-1.06 1.06l-1.06-1.06a.75.75 0 0 1 0-1.06zm9.193 9.193a.75.75 0 0 1 1.06 0l1.061 1.06a.75.75 0 0 1-1.06 1.061l-1.061-1.06a.75.75 0 0 1 0-1.061zM16 8a.75.75 0 0 1-.75.75h-1.5a.75.75 0 0 1 0-1.5h1.5A.75.75 0 0 1 16 8zM3 8a.75.75 0 0 1-.75.75H.75a.75.75 0 0 1 0-1.5h1.5A.75.75 0 0 1 3 8zm10.657-5.657a.75.75 0 0 1 0 1.061l-1.061 1.06a.75.75 0 1 1-1.06-1.06l1.06-1.06a.75.75 0 0 1 1.06 0zm-9.193 9.193a.75.75 0 0 1 0 1.06l-1.06 1.061a.75.75 0 1 1-1.061-1.06l1.06-1.061a.75.75 0 0 1 1.061 0z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent="pink"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M9.598 1.591a.75.75 0 0 1 .785-.175 7 7 0 1 1-8.967 8.967.75.75 0 0 1 .961-.96 5.5 5.5 0 0 0 7.046-7.046.75.75 0 0 1 .175-.786zm1.616 1.945a7 7 0 0 1-7.678 7.678 5.5 5.5 0 1 0 7.678-7.678z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/jpsca/sqla-wrapper" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg>
  </div>
  <div class="md-source__repository">
    jpsca/sqla-wrapper
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="SQLA Wrapper" class="md-nav__button md-logo" aria-label="SQLA Wrapper" data-md-component="logo">
      
  <img src="../assets/img/logo.svg" alt="logo">

    </a>
    SQLA Wrapper
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/jpsca/sqla-wrapper" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg>
  </div>
  <div class="md-source__repository">
    jpsca/sqla-wrapper
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          SQLAlchemy
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="SQLAlchemy" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          SQLAlchemy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sqlalchemy-wrapper/" class="md-nav__link">
        SQLAlchemy wrapper
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../working-with-the-session/" class="md-nav__link">
        Working with the session
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Testing with a real database
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Testing with a real database
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-manually-create-an-empty-database-for-testing" class="md-nav__link">
    1. Manually create an empty database for testing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-prepare-the-database-before-running-the-test-suite" class="md-nav__link">
    2. Prepare the database before running the test suite
  </a>
  
    <nav class="md-nav" aria-label="2. Prepare the database before running the test suite">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pytest" class="md-nav__link">
    pytest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unittest" class="md-nav__link">
    unittest
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-run-each-test-inside-a-transaction-and-rollback-at-the-end" class="md-nav__link">
    3. Run each test inside a transaction and rollback at the end
  </a>
  
    <nav class="md-nav" aria-label="3. Run each test inside a transaction and rollback at the end">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pytest_1" class="md-nav__link">
    pytest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unittest_1" class="md-nav__link">
    unittest
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    API
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" data-md-state="indeterminate" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Alembic
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Alembic" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Alembic
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../alembic-wrapper/" class="md-nav__link">
        Alembic wrapper
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../how-to/" class="md-nav__link">
        How to ...?
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        API Reference
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-manually-create-an-empty-database-for-testing" class="md-nav__link">
    1. Manually create an empty database for testing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-prepare-the-database-before-running-the-test-suite" class="md-nav__link">
    2. Prepare the database before running the test suite
  </a>
  
    <nav class="md-nav" aria-label="2. Prepare the database before running the test suite">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pytest" class="md-nav__link">
    pytest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unittest" class="md-nav__link">
    unittest
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-run-each-test-inside-a-transaction-and-rollback-at-the-end" class="md-nav__link">
    3. Run each test inside a transaction and rollback at the end
  </a>
  
    <nav class="md-nav" aria-label="3. Run each test inside a transaction and rollback at the end">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pytest_1" class="md-nav__link">
    pytest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unittest_1" class="md-nav__link">
    unittest
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    API
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="testing-with-a-real-database">Testing with a real database<a class="headerlink" href="#testing-with-a-real-database" title="Permanent link">#</a></h1>
<p>&ldquo;Testing with a real database, was not that supposed to be a no-no?&rdquo; - you might be thinking. Many tutorials have always reccomended mocking your database so your unit-tests are fast.</p>
<p>More often than not, thiugh, that is bad advice. For databases like PostgreSQL or MySQLfor whatever short-term gains you might get, you lose in long-term maintainability.</p>
<p>Mocking your database is not only a lot of overhead but, after a while, the mocks no longer reflect the actual code and what is happening on the real database server.</p>
<p>We need each test to be isolated from others: you should never have to think about what other tests have put in the database. However, creating tables, loading fixtures, and dropping those tables for each test is too slow. The good news is, you don&rsquo;t need to do it for each test. You will not have to worry about database performance issues if you follow this setup.</p>
<h2 id="1-manually-create-an-empty-database-for-testing">1. Manually create an empty database for testing<a class="headerlink" href="#1-manually-create-an-empty-database-for-testing" title="Permanent link">#</a></h2>
<p>First, you need to manually create a new (and empty) database for your tests to use. This could mean manually running a command like <code>createdb myapp-tests</code> or adding another database service in your development <code>docker-compose.yml</code> file.</p>
<p>You should use the same type of database as the one used by your application. Otherwise, your tests could be affected by implementation details of the database engines, like the default order of null values, and not being able to test what would happen in production.</p>
<h2 id="2-prepare-the-database-before-running-the-test-suite">2. Prepare the database before running the test suite<a class="headerlink" href="#2-prepare-the-database-before-running-the-test-suite" title="Permanent link">#</a></h2>
<p>The test database exists but is empty at this point, so before we run any test, we need to create all the tables and insert the minimal fixture data necessary to run the application.</p>
<p>We must configure our tests to do this every time we run the tests, but only once. There is no need to run any migrations because we can create all the tables from the models definition. You can however &ldquo;stamp&rdquo; it with the latest revision if some test expects the <code>alembic_version</code> table to exists.</p>
<h3 id="pytest">pytest<a class="headerlink" href="#pytest" title="Permanent link">#</a></h3>
<p>With <strong>pytest</strong> this can be done with a session-scoped fixture:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">myapp.models</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">alembic</span><span class="p">,</span> <span class="n">load_fixture_data</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dbsetup</span><span class="p">():</span>
    <span class="k">assert</span> <span class="s2">&quot;_test&quot;</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">url</span>  <span class="c1"># better to be safe than sorry</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
    <span class="n">alembic</span><span class="o">.</span><span class="n">stamp</span><span class="p">()</span>  <span class="c1"># optional</span>
    <span class="n">load_fixture_data</span><span class="p">()</span>  <span class="c1"># optional</span>
    <span class="k">yield</span>
    <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
</code></pre></div>
<h3 id="unittest">unittest<a class="headerlink" href="#unittest" title="Permanent link">#</a></h3>
<p>With <strong>unitest</strong>, we do it with the <code>setUpClass</code> and <code>tearDownClass</code> class methods in a base class. Other test cases must inherit from this class to make it work.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># base.py</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">from</span> <span class="nn">myapp.models</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">alembic</span><span class="p">,</span> <span class="n">load_fixture_data</span>

<span class="k">class</span> <span class="nc">DBTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">assert</span> <span class="s2">&quot;_test&quot;</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">url</span>  <span class="c1"># better to be safe than sorry</span>
        <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
        <span class="n">alembic</span><span class="o">.</span><span class="n">stamp</span><span class="p">()</span>  <span class="c1"># optional</span>
        <span class="n">load_fixture_data</span><span class="p">()</span>  <span class="c1"># optional</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
</code></pre></div>
<h2 id="3-run-each-test-inside-a-transaction-and-rollback-at-the-end">3. Run each test inside a transaction and rollback at the end<a class="headerlink" href="#3-run-each-test-inside-a-transaction-and-rollback-at-the-end" title="Permanent link">#</a></h2>
<p>This part is the main trick, and <strong>sqla-wrapper</strong> includes a <code>db.test_transaction()</code> method that does it for you:</p>
<div class="highlight"><pre><span></span><code><span class="n">trans</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">test_transaction</span><span class="p">()</span>
<span class="o">...</span>
<span class="n">trans</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
<p>By wrapping each test in a root transaction, we make sure that it will not alter the state of the database, even if we commit during the test since the transaction is rolled back on test teardown.</p>
<p>There is only one caveat: if you want to allow tests to also use rollbacks within them, your database must support SAVEPOINT.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>test_transaction()</code> internally follow this recipe:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. Start a transaction on a new connection</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="n">trans</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>

<span class="c1"># 2. Bind a new session to this connection</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">connection</span><span class="p">)</span>
<span class="c1"># and registers it as the new scoped session</span>

<span class="c1"># 3. If your database supports it, start a savepoint to allow rollbacks within a test</span>
<span class="n">nested</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">begin_nested</span><span class="p">()</span>

<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="s2">&quot;after_transaction_end&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">end_savepoint</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">transaction</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nested</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="n">nested</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">begin_nested</span><span class="p">()</span>

<span class="c1"># 4. Run the test</span>
<span class="c1"># ...</span>

<span class="c1"># 5. Finally, rollback any changes and close the connection.</span>
<span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">trans</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
<p>This recipe is what <a href="https://docs.sqlalchemy.org/en/14/orm/session_transaction.html#session-external-transaction">SQLAlchemy documentation</a> recommends and even test in their own CI to ensure that it remains working as expected.</p>
</div>
<h3 id="pytest_1">pytest<a class="headerlink" href="#pytest_1" title="Permanent link">#</a></h3>
<p>With <strong>pytest</strong>, we can use a regular fixture and make it <em>depend</em> on the <code>dbsetup()</code> fixture we created before. Although this new fixture will run (automatically) before each test, the setup fixture will run only once, as we need to.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">myapp.models</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">alembic</span><span class="p">,</span> <span class="n">load_fixture_data</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dbsetup</span><span class="p">():</span>
    <span class="c1"># ...</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">dbs</span><span class="p">(</span><span class="n">dbsetup</span><span class="p">):</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">test_transaction</span><span class="p">()</span>
    <span class="c1"># Or, if you need to rollback in your tests</span>
    <span class="c1">#   = db.test_transaction(savepoint=True)</span>
    <span class="k">yield</span>
    <span class="n">trans</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
<p>Then, we use that database session fixture for the tests that require interacting with the database. You can safely use the &ldquo;global&rdquo; scoped session, because it nows point to the test session.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test_something.py</span>
<span class="kn">from</span> <span class="nn">myapp.models</span> <span class="kn">import</span> <span class="n">db</span>

<span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="n">dbs</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">some_stmt</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="o">...</span>
</code></pre></div>
<h3 id="unittest_1">unittest<a class="headerlink" href="#unittest_1" title="Permanent link">#</a></h3>
<p>With <strong>unittest</strong> we use the <code>setUp()</code> and <code>tearDown()</code> methods</p>
<div class="highlight"><pre><span></span><code><span class="c1"># base.py</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">from</span> <span class="nn">myapp.models</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">alembic</span><span class="p">,</span> <span class="n">load_fixture_data</span>

<span class="k">class</span> <span class="nc">DBTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># ...</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># ...</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trans</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">test_transaction</span><span class="p">()</span>
        <span class="c1"># Or, if you need to rollback in your tests</span>
        <span class="c1">#   = db.test_transaction(savepoint=True)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trans</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># ...</span>
</code></pre></div>
<p>Then, we inherit from that class for the tests that require interacting with the database.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test_something.py</span>
<span class="kn">from</span> <span class="nn">myapp.models</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">DBTestCase</span>

<span class="k">class</span> <span class="nc">TestSomething</span><span class="p">(</span><span class="n">DBTestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">db</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">some_stmt</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c1"># ...</span>
</code></pre></div>
<h2 id="api">API<a class="headerlink" href="#api" title="Permanent link">#</a></h2>
<div class="autodoc">
<div class="autodoc-signature"><em>class </em><code>sqla_wrapper.<strong>TestTransaction</strong></code><span class="autodoc-punctuation">(</span><em class="autodoc-param">db</em><span class="autodoc-punctuation">, </span><em class="autodoc-param">savepoint=False</em><span class="autodoc-punctuation">)</span></div>
<div class="autodoc-members">
<div class="autodoc-signature"><code><strong>close</strong></code><span class="autodoc-punctuation">(</span><em class="autodoc-param">self</em><span class="autodoc-punctuation">)</span></div>
<div class="autodoc-docstring"></div>
</div>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../working-with-the-session/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Working with the session" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Working with the session
            </div>
          </div>
        </a>
      
      
        
        <a href="../alembic-wrapper/" class="md-footer__link md-footer__link--next" aria-label="Next: Alembic wrapper" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Alembic wrapper
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2013 - 2021 Juan-Pablo Scaletti
          </div>
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.expand", "navigation.top", "navigation.tracking", "search.suggest", "search.highligh"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.8397ff9e.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.1e84347e.min.js"></script>
      
    
  </body>
</html>